resource "aws_iam_policy" "GRACE_SecOps_Admins_Policy" {
  name        = "GRACE_SecOps_Admins_Policy"
  path        = "/"
  description = "GRACE_SecOps_Admins_Policy"

  policy = <<EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ssm:SendCommand",
                "ssm:CancelCommand",
                "ssm:ListCommands",
                "ssm:SendAutomationSignal",
                "ssm:CreateActivation",
                "ssm:ListInstanceAssociations",
                "ssm:UpdateAssociation",
                "ssm:UpdateAssociationStatus",
                "ssm:DescribeAutomationExecutions",
                "ssm:GetMaintenanceWindowTask",
                "ssm:DescribeMaintenanceWindowExecutionTaskInvocations",
                "ssm:RegisterPatchBaselineForPatchGroup",
                "ssm:DescribeAutomationStepExecutions",
                "ssm:RemoveTagsFromResource",
                "ssm:ListResourceDataSync",
                "ssm:ListDocuments",
                "ssm:UpdateDocument",
                "ssm:UpdateManagedInstanceRole",
                "ssm:UpdatePatchBaseline",
                "ssm:GetMaintenanceWindowExecutionTask",
                "ssm:RegisterTaskWithMaintenanceWindow",
                "apigateway:*",
                "ssm:GetMaintenanceWindowExecution",
                "ssm:CreateDocument",
                "ssm:UpdateMaintenanceWindow",
                "ssm:StartAutomationExecution",
                "cloudwatch:*",
                "ssm:DescribeMaintenanceWindows",
                "ssm:CreateAssociation",
                "ssm:DescribeEffectivePatchesForPatchBaseline",
                "ecs:*",
                "ec2:*",
                "ssm:DescribeDocumentPermission",
                "ssm:GetAutomationExecution",
                "ssm:DescribePatchGroups",
                "ssm:GetDefaultPatchBaseline",
                "ssm:DescribeDocument",
                "cloudtrail:*",
                "ssm:ListAssociationVersions",
                "ssm:PutConfigurePackageResult",
                "ssm:DescribePatchGroupState",
                "ssm:UpdateMaintenanceWindowTask",
                "ssm:CreatePatchBaseline",
                "ssm:DescribeMaintenanceWindowExecutionTasks",
                "ssm:DescribeInstancePatchStatesForPatchGroup",
                "ssm:GetDocument",
                "ssm:CreateResourceDataSync",
                "ssm:GetInventorySchema",
                "ssm:CreateMaintenanceWindow",
                "ssm:GetMaintenanceWindow",
                "ssm:GetPatchBaseline",
                "ssm:ListInventoryEntries",
                "ssm:DescribeAssociation",
                "s3:*",
                "guardduty:*",
                "ssm:DescribePatchBaselines",
                "ssm:DeregisterPatchBaselineForPatchGroup",
                "ssm:StopAutomationExecution",
                "elasticbeanstalk:*",
                "ssm:DescribeInstanceInformation",
                "ssm:ListTagsForResource",
                "ssm:CreateAssociationBatch",
                "ssm:ModifyDocumentPermission",
                "ssm:DescribeDocumentParameters",
                "ecr:*",
                "ssm:RegisterDefaultPatchBaseline",
                "ssm:UpdateInstanceAssociationStatus",
                "acm:*",
                "ssm:DeregisterTargetFromMaintenanceWindow",
                "ssm:ListDocumentVersions",
                "ssm:UpdateDocumentDefaultVersion",
                "logs:*",
                "ssm:DescribeInstancePatches",
                "autoscaling:*",
                "ssm:UpdateMaintenanceWindowTarget",
                "ssm:GetMaintenanceWindowExecutionTaskInvocation",
                "ssm:DeleteActivation",
                "cloudfront:*",
                "ssm:StartAssociationsOnce",
                "ssm:UpdateInstanceInformation",
                "ssm:AddTagsToResource",
                "opsworks:*",
                "config:*",
                "ssm:PutComplianceItems",
                "events:*",
                "inspector:*",
                "directconnect:*",
                "cloudformation:*",
                "ssm:RegisterTargetWithMaintenanceWindow",
                "iam:*",
                "waf:*",
                "servicecatalog:*",
                "ssm:ListCommandInvocations",
                "lightsail:*",
                "shield:*",
                "ssm:DescribeMaintenanceWindowTasks",
                "ssm:GetPatchBaselineForPatchGroup",
                "ssm:DeletePatchBaseline",
                "ssm:DescribeMaintenanceWindowExecutions",
                "ssm:GetManifest",
                "ds:*",
                "batch:*",
                "ssm:DescribeInstancePatchStates",
                "artifact:*",
                "ssm:DeleteResourceDataSync",
                "ssm:DeregisterTaskFromMaintenanceWindow",
                "ssm:DescribeInstanceAssociationsStatus",
                "ssm:DescribeInstanceProperties",
                "ssm:GetDeployablePatchSnapshotForInstance",
                "ssm:DescribeMaintenanceWindowTargets",
                "cloudhsm:*",
                "ssm:DeleteMaintenanceWindow",
                "ssm:DescribeEffectiveInstanceAssociations",
                "ssm:GetInventory",
                "ssm:DescribeActivations",
                "ssm:GetCommandInvocation",
                "ssm:DeleteAssociation",
                "ssm:DeregisterManagedInstance",
                "trustedadvisor:*",
                "ssm:PutInventory",
                "sso:*",
                "route53:*",
                "ssm:ListAssociations",
                "ssm:DeleteDocument",
                "ssm:DescribeAvailablePatches"
            ],
            "Resource": "*"
        }
    ]
}
EOF
}

resource "aws_iam_policy" "GRACE_SecOps_View_Only_Policy" {
  name        = "GRACE_SecOps_View_Only_Policy"
  path        = "/"
  description = "GRACE_SecOps_View_Only_Policy"

  policy = <<EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "config:GetComplianceSummaryByConfigRule",
                "iam:GetAccountPasswordPolicy",
                "ssm:ListCommands",
                "opsworks:GetHostnameSuggestion",
                "route53:ListTrafficPolicyVersions",
                "servicecatalog:DescribeProvisioningParameters",
                "route53:TestDNSAnswer",
                "iam:GenerateServiceLastAccessedDetails",
                "cloudtrail:GetTrailStatus",
                "route53:GetHealthCheck",
                "servicecatalog:DescribeProductView",
                "lambda:GetFunctionConfiguration",
                "batch:DescribeComputeEnvironments",
                "ecs:DescribeTaskDefinition",
                "config:GetComplianceDetailsByResource",
                "ssm:DescribeAutomationExecutions",
                "ssm:GetMaintenanceWindowTask",
                "ssm:DescribeAutomationStepExecutions",
                "cloudformation:DescribeStackEvents",
                "iam:SimulateCustomPolicy",
                "cloudfront:GetStreamingDistribution",
                "ec2:DescribeScheduledInstanceAvailability",
                "logs:FilterLogEvents",
                "cloudformation:DescribeChangeSet",
                "iam:GetCredentialReport",
                "lambda:GetAlias",
                "cloudfront:GetDistributionConfig",
                "trustedadvisor:DescribeNotificationPreferences",
                "iam:GetRole",
                "cloudfront:GetCloudFrontOriginAccessIdentityConfig",
                "events:DescribeRule",
                "ssm:GetMaintenanceWindowExecutionTask",
                "iam:GetPolicy",
                "lambda:GetEventSourceMapping",
                "ssm:GetMaintenanceWindowExecution",
                "route53:ListVPCAssociationAuthorizations",
                "route53:GetReusableDelegationSetLimit",
                "ecr:GetAuthorizationToken",
                "cloudwatch:GetMetricStatistics",
                "events:TestEventPattern",
                "route53:ListTagsForResources",
                "route53:GetAccountLimit",
                "ec2:GetPasswordData",
                "cloudformation:GetStackPolicy",
                "config:GetTagKeys",
                "ec2:DescribeScheduledInstances",
                "ssm:DescribeEffectivePatchesForPatchBaseline",
                "cloudwatch:DescribeAlarms",
                "ssm:DescribeDocumentPermission",
                "iam:GetOpenIDConnectProvider",
                "route53:GetTrafficPolicy",
                "iam:GetRolePolicy",
                "iam:GenerateCredentialReport",
                "ssm:GetAutomationExecution",
                "batch:DescribeJobQueues",
                "ssm:GetDefaultPatchBaseline",
                "ssm:DescribeDocument",
                "config:GetComplianceSummaryByResourceType",
                "ssm:PutConfigurePackageResult",
                "ssm:DescribePatchGroupState",
                "iam:GetServiceLastAccessedDetails",
                "cognito-identity:GetIdentityPoolRoles",
                "cloudformation:EstimateTemplateCost",
                "iam:GetServiceLinkedRoleDeletionStatus",
                "cloudwatch:DescribeAlarmHistory",
                "batch:DescribeJobs",
                "config:GetComplianceDetailsByConfigRule",
                "ssm:DescribeInstancePatchStatesForPatchGroup",
                "lambda:ListTags",
                "ssm:GetDocument",
                "ssm:GetInventorySchema",
                "ssm:GetParametersByPath",
                "ssm:GetMaintenanceWindow",
                "route53:GetTrafficPolicyInstance",
                "config:DeliverConfigSnapshot",
                "ecs:DescribeTasks",
                "ssm:GetPatchBaseline",
                "directconnect:ConfirmConnection",
                "cognito-identity:DescribeIdentityPool",
                "trustedadvisor:DescribeCheckRefreshStatuses",
                "ssm:DescribeAssociation",
                "cloudfront:GetStreamingDistributionConfig",
                "iam:GetSSHPublicKey",
                "config:GetResourceConfigHistory",
                "logs:TestMetricFilter",
                "trustedadvisor:DescribeCheckItems",
                "route53:ListTagsForResource",
                "iam:GetContextKeysForCustomPolicy",
                "ssm:DescribeInstanceInformation",
                "cognito-identity:LookupDeveloperIdentity",
                "ssm:ListTagsForResource",
                "cloudtrail:ListPublicKeys",
                "ssm:DescribeDocumentParameters",
                "apigateway:HEAD",
                "iam:GetUser",
                "cognito-identity:GetCredentialsForIdentity",
                "iam:GetPolicyVersion",
                "ec2:GetHostReservationPurchasePreview",
                "ec2:DescribeVolumesModifications",
                "ssm:DescribeInstancePatches",
                "cloudformation:DescribeStackResource",
                "servicecatalog:DescribeRecord",
                "cognito-identity:GetOpenIdToken",
                "ssm:GetParameter",
                "ec2:GetConsoleScreenshot",
                "ssm:GetMaintenanceWindowExecutionTaskInvocation",
                "cloudfront:GetDistribution",
                "iam:SimulatePrincipalPolicy",
                "ec2:GetLaunchTemplateData",
                "cloudwatch:DescribeAlarmsForMetric",
                "cloudtrail:ListTags",
                "logs:GetLogEvents",
                "servicecatalog:DescribeProvisioningArtifact",
                "iam:GetAccountAuthorizationDetails",
                "apigateway:GET",
                "ecr:BatchCheckLayerAvailability",
                "cognito-identity:DescribeIdentity",
                "directconnect:ConfirmPublicVirtualInterface",
                "iam:GetServerCertificate",
                "cloudwatch:GetDashboard",
                "ec2:DescribeVpnConnections",
                "ecr:GetDownloadUrlForLayer",
                "route53:ListTrafficPolicyInstancesByHostedZone",
                "iam:GetAccessKeyLastUsed",
                "cloudformation:DescribeStackResources",
                "ssm:GetParameters",
                "ec2:GetReservedInstancesExchangeQuote",
                "ecs:DescribeClusters",
                "directconnect:ConfirmPrivateVirtualInterface",
                "trustedadvisor:DescribeCheckSummaries",
                "servicecatalog:DescribePortfolio",
                "iam:GetUserPolicy",
                "cloudfront:ListTagsForResource",
                "cloudformation:GetTemplate",
                "ecr:BatchGetImage",
                "ecr:DescribeImages",
                "batch:DescribeJobDefinitions",
                "route53:GetHostedZoneLimit",
                "iam:GetGroupPolicy",
                "ec2:DescribeElasticGpus",
                "ssm:ListCommandInvocations",
                "route53:ListTrafficPolicyInstances",
                "route53:GetTrafficPolicyInstanceCount",
                "cloudwatch:GetMetricData",
                "iam:GetServiceLastAccessedDetailsWithEntities",
                "ssm:GetPatchBaselineForPatchGroup",
                "lambda:GetAccountSettings",
                "cloudtrail:GetEventSelectors",
                "iam:GetGroup",
                "iam:GetContextKeysForPrincipalPolicy",
                "ec2:GetConsoleOutput",
                "ssm:GetManifest",
                "ssm:DescribeInstancePatchStates",
                "servicecatalog:DescribeProduct",
                "route53:ListTrafficPolicies",
                "cloudformation:DescribeAccountLimits",
                "cloudfront:GetCloudFrontOriginAccessIdentity",
                "ecs:DescribeServices",
                "ecs:DescribeContainerInstances",
                "ssm:DescribeInstanceAssociationsStatus",
                "iam:GetSAMLProvider",
                "ssm:DescribeInstanceProperties",
                "route53:GetQueryLoggingConfig",
                "iam:GetInstanceProfile",
                "ssm:GetDeployablePatchSnapshotForInstance",
                "ssm:GetParameterHistory",
                "lambda:GetFunction",
                "ec2:DescribeTags",
                "cloudfront:GetInvalidation",
                "cognito-identity:GetOpenIdTokenForDeveloperIdentity",
                "ssm:DescribeEffectiveInstanceAssociations",
                "ssm:GetInventory",
                "ssm:DescribeActivations",
                "apigateway:OPTIONS",
                "ssm:GetCommandInvocation",
                "cloudformation:GetTemplateSummary",
                "servicecatalog:DescribeConstraint",
                "cloudformation:PreviewStackUpdate",
                "route53:ListTrafficPolicyInstancesByPolicy",
                "servicecatalog:DescribeProductAsAdmin",
                "config:GetResources",
                "lambda:GetPolicy",
                "ecr:GetRepositoryPolicy",
                "ssm:DescribeAvailablePatches"
            ],
            "Resource": "*"
        }
    ]
}
EOF
}

resource "aws_iam_role_policy_attachment" "grace_secops_admins_policy_attachment_" {
  role       = "${aws_iam_role.secops_admin_role.name}"
  policy_arn = "${aws_iam_policy.GRACE_SecOps_Admins_Policy.arn}"
}

resource "aws_iam_role_policy_attachment" "grace_secops_view_only_policy_attachment" {
  role       = "${aws_iam_role.secops_read_only_role.name}"
  policy_arn = "${aws_iam_policy.GRACE_SecOps_View_Only_Policy.arn}"
}
